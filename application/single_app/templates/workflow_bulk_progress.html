{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
    <div class="card mx-1 mx-md-3 mx-lg-4">
        <div class="card-header">
            <h2 class="mb-0">
                <i class="fas fa-tasks me-2"></i>
                Bulk Workflow - Processing Progress
            </h2>
            <nav aria-label="breadcrumb" class="mt-2">
                <ol class="breadcrumb mb-0">
                    <li class="breadcrumb-item"><a href="{{ url_for('workflow_scope_selection') }}">Scope</a></li>
                    <li class="breadcrumb-item">Processing Mode</li>
                    <li class="breadcrumb-item">Documents</li>
                    <li class="breadcrumb-item">Processing Options</li>
                    <li class="breadcrumb-item active" aria-current="page">Progress</li>
                </ol>
            </nav>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-8">
                    <!-- Job Information -->
                    <div class="card bg-light mb-4">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h5><i class="fas fa-info-circle text-primary me-2"></i>Job Information</h5>
                                    <p class="mb-1"><strong>Job ID:</strong> <code id="jobId">{{ job_id }}</code></p>
                                    <p class="mb-1"><strong>Workflow Type:</strong> <span id="workflowType">Loading...</span></p>
                                    <p class="mb-1"><strong>Processing Mode:</strong> <span id="processingMode">Loading...</span></p>
                                    <p class="mb-0"><strong>Documents:</strong> <span id="documentCount">Loading...</span></p>
                                </div>
                                <div class="col-md-6">
                                    <h5><i class="fas fa-clock text-info me-2"></i>Timing</h5>
                                    <p class="mb-1"><strong>Started:</strong> <span id="startTime">Loading...</span></p>
                                    <p class="mb-1"><strong>Elapsed:</strong> <span id="elapsedTime">0s</span></p>
                                    <p class="mb-0"><strong>ETA:</strong> <span id="estimatedTime">Calculating...</span></p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Progress Overview -->
                    <div class="card mb-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Overall Progress</h5>
                            <span class="badge" id="statusBadge">Initializing</span>
                        </div>
                        <div class="card-body">
                            <div class="progress mb-3" style="height: 25px;">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                     role="progressbar" 
                                     style="width: 0%" 
                                     id="overallProgress">
                                    <span id="progressText">0%</span>
                                </div>
                            </div>
                            
                            <div class="d-flex justify-content-between text-muted">
                                <span id="currentStep">Initializing job...</span>
                                <span id="progressStats">0 / 0 completed</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Document Progress (for individual processing) -->
                    <div class="card mb-4" id="documentProgressCard" style="display: none;">
                        <div class="card-header">
                            <h5 class="mb-0">Document Progress</h5>
                        </div>
                        <div class="card-body">
                            <div id="documentProgressList">
                                <!-- Document progress items will be dynamically added here -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Live Activity Log -->
                    <div class="card mb-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Activity Log</h5>
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="clearLogBtn">
                                <i class="fas fa-trash me-1"></i>Clear Log
                            </button>
                        </div>
                        <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                            <div id="activityLog">
                                <div class="log-entry">
                                    <span class="timestamp">{{ moment().format('HH:mm:ss') }}</span>
                                    <span class="text-info">Job initialized, waiting for status update...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Sidebar -->
                <div class="col-md-4">
                    <!-- Control Panel -->
                    <div class="card bg-light mb-4">
                        <div class="card-body">
                            <h5>Control Panel</h5>
                            
                            <div class="d-grid gap-2">
                                <button type="button" class="btn btn-outline-warning" id="pauseBtn" disabled>
                                    <i class="fas fa-pause me-1"></i>Pause Job
                                </button>
                                <button type="button" class="btn btn-outline-danger" id="cancelBtn" disabled>
                                    <i class="fas fa-stop me-1"></i>Cancel Job
                                </button>
                            </div>
                            
                            <hr>
                            
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="autoRefresh" checked>
                                <label class="form-check-label" for="autoRefresh">
                                    Auto-refresh (2s)
                                </label>
                            </div>
                            
                            <div class="mt-2">
                                <button type="button" class="btn btn-sm btn-outline-primary" id="refreshBtn">
                                    <i class="fas fa-sync-alt me-1"></i>Refresh Now
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Results Preview -->
                    <div class="card" id="resultsCard" style="display: none;">
                        <div class="card-body">
                            <h5><i class="fas fa-check-circle text-success me-2"></i>Processing Complete!</h5>
                            <p>Your bulk workflow has completed successfully.</p>
                            
                            <div class="d-grid gap-2">
                                <button type="button" class="btn btn-primary" id="viewResultsBtn">
                                    <i class="fas fa-eye me-1"></i>View Results
                                </button>
                                <button type="button" class="btn btn-outline-secondary" id="downloadResultsBtn">
                                    <i class="fas fa-download me-1"></i>Download Results
                                </button>
                            </div>
                            
                            <hr>
                            
                            <div class="small text-muted">
                                <p class="mb-1"><strong>Processing Summary:</strong></p>
                                <p class="mb-1" id="completionSummary">Details loading...</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Error Panel -->
                    <div class="card border-danger" id="errorCard" style="display: none;">
                        <div class="card-body">
                            <h5 class="text-danger">
                                <i class="fas fa-exclamation-triangle me-2"></i>Processing Error
                            </h5>
                            <p id="errorMessage">An error occurred during processing.</p>
                            
                            <div class="d-grid gap-2">
                                <button type="button" class="btn btn-outline-primary" id="retryBtn">
                                    <i class="fas fa-redo me-1"></i>Retry Processing
                                </button>
                                <button type="button" class="btn btn-outline-secondary" id="reportErrorBtn">
                                    <i class="fas fa-bug me-1"></i>Report Issue
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let jobId = '{{ job_id }}';
let refreshInterval;
let startTime = new Date();

document.addEventListener('DOMContentLoaded', function() {
    startProgressTracking();
    setupEventListeners();
});

function setupEventListeners() {
    // Auto-refresh toggle
    document.getElementById('autoRefresh').addEventListener('change', function() {
        if (this.checked) {
            startProgressTracking();
        } else {
            stopProgressTracking();
        }
    });
    
    // Manual refresh
    document.getElementById('refreshBtn').addEventListener('click', function() {
        updateProgress();
    });
    
    // Clear log
    document.getElementById('clearLogBtn').addEventListener('click', function() {
        document.getElementById('activityLog').innerHTML = '';
        addLogEntry('Log cleared', 'text-muted');
    });
    
    // Control buttons
    document.getElementById('pauseBtn').addEventListener('click', pauseJob);
    document.getElementById('cancelBtn').addEventListener('click', cancelJob);
    document.getElementById('retryBtn').addEventListener('click', retryJob);
    
    // Results buttons
    document.getElementById('viewResultsBtn').addEventListener('click', viewResults);
    document.getElementById('downloadResultsBtn').addEventListener('click', downloadResults);
}

function startProgressTracking() {
    stopProgressTracking(); // Clear any existing interval
    updateProgress(); // Initial update
    refreshInterval = setInterval(updateProgress, 2000); // Every 2 seconds
}

function stopProgressTracking() {
    if (refreshInterval) {
        clearInterval(refreshInterval);
        refreshInterval = null;
    }
}

function updateProgress() {
    fetch(`{{ url_for('api_workflow_bulk_status', job_id='') }}${jobId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateProgressDisplay(data.status);
                updateElapsedTime();
            } else {
                addLogEntry(`Error getting status: ${data.error}`, 'text-danger');
            }
        })
        .catch(error => {
            console.error('Error fetching progress:', error);
            addLogEntry('Connection error - retrying...', 'text-warning');
        });
}

function updateProgressDisplay(status) {
    // Update job information
    document.getElementById('jobId').textContent = jobId;
    document.getElementById('workflowType').textContent = getWorkflowTypeLabel(status.workflow_type);
    document.getElementById('processingMode').textContent = getProcessingModeLabel(status.processing_mode);
    document.getElementById('documentCount').textContent = `${status.total_documents} documents`;
    
    if (status.start_time) {
        startTime = new Date(status.start_time);
        document.getElementById('startTime').textContent = startTime.toLocaleTimeString();
    }
    
    // Update progress bar
    const progressBar = document.getElementById('overallProgress');
    const progressText = document.getElementById('progressText');
    const currentStep = document.getElementById('currentStep');
    const progressStats = document.getElementById('progressStats');
    const statusBadge = document.getElementById('statusBadge');
    
    const percentage = Math.round((status.completed_documents / status.total_documents) * 100) || 0;
    
    progressBar.style.width = `${percentage}%`;
    progressText.textContent = `${percentage}%`;
    progressStats.textContent = `${status.completed_documents} / ${status.total_documents} completed`;
    
    // Update status badge
    updateStatusBadge(status.status, statusBadge);
    
    // Update current step
    currentStep.textContent = status.current_step || 'Processing...';
    
    // Show/hide document progress for individual processing
    if (status.processing_mode === 'individual' && status.document_progress) {
        showDocumentProgress(status.document_progress);
    }
    
    // Handle completion or errors
    if (status.status === 'completed') {
        handleCompletion(status);
    } else if (status.status === 'failed') {
        handleError(status);
    }
    
    // Add activity log entries
    if (status.recent_activities) {
        status.recent_activities.forEach(activity => {
            addLogEntry(activity.message, getActivityClass(activity.type), activity.timestamp);
        });
    }
}

function updateStatusBadge(status, badge) {
    badge.className = 'badge';
    
    switch (status) {
        case 'queued':
            badge.classList.add('bg-secondary');
            badge.textContent = 'Queued';
            break;
        case 'running':
            badge.classList.add('bg-primary');
            badge.textContent = 'Running';
            break;
        case 'completed':
            badge.classList.add('bg-success');
            badge.textContent = 'Completed';
            break;
        case 'failed':
            badge.classList.add('bg-danger');
            badge.textContent = 'Failed';
            break;
        case 'cancelled':
            badge.classList.add('bg-warning');
            badge.textContent = 'Cancelled';
            break;
        case 'paused':
            badge.classList.add('bg-info');
            badge.textContent = 'Paused';
            break;
        default:
            badge.classList.add('bg-secondary');
            badge.textContent = 'Unknown';
    }
}

function showDocumentProgress(documentProgress) {
    const card = document.getElementById('documentProgressCard');
    const list = document.getElementById('documentProgressList');
    
    card.style.display = 'block';
    
    let html = '';
    documentProgress.forEach(doc => {
        const percentage = doc.status === 'completed' ? 100 : (doc.status === 'running' ? 50 : 0);
        const statusClass = doc.status === 'completed' ? 'bg-success' : (doc.status === 'running' ? 'bg-primary' : 'bg-secondary');
        
        html += `
            <div class="mb-3">
                <div class="d-flex justify-content-between align-items-center mb-1">
                    <span class="small">${doc.title}</span>
                    <span class="badge ${statusClass}">${doc.status}</span>
                </div>
                <div class="progress" style="height: 8px;">
                    <div class="progress-bar ${statusClass}" style="width: ${percentage}%"></div>
                </div>
                ${doc.error ? `<small class="text-danger">${doc.error}</small>` : ''}
            </div>
        `;
    });
    
    list.innerHTML = html;
}

function handleCompletion(status) {
    stopProgressTracking();
    
    const resultsCard = document.getElementById('resultsCard');
    resultsCard.style.display = 'block';
    
    const summary = document.getElementById('completionSummary');
    summary.textContent = `Processed ${status.total_documents} documents in ${getElapsedTimeText()}`;
    
    addLogEntry('Processing completed successfully!', 'text-success');
    
    // Enable results buttons
    document.getElementById('viewResultsBtn').disabled = false;
    document.getElementById('downloadResultsBtn').disabled = false;
}

function handleError(status) {
    stopProgressTracking();
    
    const errorCard = document.getElementById('errorCard');
    const errorMessage = document.getElementById('errorMessage');
    
    errorCard.style.display = 'block';
    errorMessage.textContent = status.error_message || 'An unknown error occurred during processing.';
    
    addLogEntry(`Processing failed: ${status.error_message}`, 'text-danger');
}

function updateElapsedTime() {
    const elapsed = Math.floor((new Date() - startTime) / 1000);
    document.getElementById('elapsedTime').textContent = formatDuration(elapsed);
}

function formatDuration(seconds) {
    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    const secs = seconds % 60;
    
    if (hours > 0) {
        return `${hours}h ${minutes}m ${secs}s`;
    } else if (minutes > 0) {
        return `${minutes}m ${secs}s`;
    } else {
        return `${secs}s`;
    }
}

function addLogEntry(message, className = 'text-info', timestamp = null) {
    const log = document.getElementById('activityLog');
    const time = timestamp ? new Date(timestamp) : new Date();
    
    const entry = document.createElement('div');
    entry.className = 'log-entry';
    entry.innerHTML = `
        <span class="timestamp">${time.toLocaleTimeString()}</span>
        <span class="${className}">${message}</span>
    `;
    
    log.appendChild(entry);
    log.scrollTop = log.scrollHeight; // Auto-scroll to bottom
}

function getActivityClass(type) {
    switch (type) {
        case 'error': return 'text-danger';
        case 'warning': return 'text-warning';
        case 'success': return 'text-success';
        case 'info': return 'text-info';
        default: return 'text-muted';
    }
}

function getWorkflowTypeLabel(type) {
    const labels = {
        'summary': 'Document Summary',
        'pii_analysis': 'PII Analysis',
        'translation': 'Translation'
    };
    return labels[type] || type;
}

function getProcessingModeLabel(mode) {
    const labels = {
        'individual': 'Individual Processing',
        'combined': 'Combined Processing'
    };
    return labels[mode] || mode;
}

function getElapsedTimeText() {
    const elapsed = Math.floor((new Date() - startTime) / 1000);
    return formatDuration(elapsed);
}

// Control functions
function pauseJob() {
    // Implementation for pausing job
    addLogEntry('Pause functionality not yet implemented', 'text-warning');
}

function cancelJob() {
    if (confirm('Are you sure you want to cancel this job? This action cannot be undone.')) {
        // Implementation for cancelling job
        addLogEntry('Cancel functionality not yet implemented', 'text-warning');
    }
}

function retryJob() {
    if (confirm('Are you sure you want to retry this job?')) {
        // Implementation for retrying job
        addLogEntry('Retry functionality not yet implemented', 'text-warning');
    }
}

function viewResults() {
    // Redirect to results view
    window.location.href = `{{ url_for('workflow_results') }}?job_id=${jobId}`;
}

function downloadResults() {
    // Trigger download
    window.open(`{{ url_for('api_workflow_bulk_download', job_id='') }}${jobId}`, '_blank');
}
</script>

<style>
.log-entry {
    border-bottom: 1px solid #eee;
    padding: 5px 0;
    font-size: 0.9em;
}

.log-entry:last-child {
    border-bottom: none;
}

.timestamp {
    color: #6c757d;
    margin-right: 10px;
    font-family: monospace;
}

.progress {
    transition: width 0.3s ease;
}

.card {
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

#activityLog {
    background-color: #f8f9fa;
    border-radius: 4px;
    padding: 10px;
}
</style>
{% endblock %}