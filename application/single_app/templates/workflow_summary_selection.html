{% extends "base.html" %}
{% block title %}
    Workflow - Summary Selection - {{ app_settings.app_title }}
{% endblock %}

{% block head %}
    <style>
        .workflow-container {
            margin: 0;
            padding: 1rem 0;
        }
        .workflow-header {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1rem 1.5rem;
            margin-bottom: 2rem;
            border-left: 4px solid #0d6efd;
        }
        .workflow-type-card {
            transition: all 0.2s ease;
            border: 2px solid transparent;
            cursor: pointer;
        }
        .workflow-type-card:hover {
            border-color: #0d6efd;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .workflow-type-card.selected {
            border-color: #0d6efd;
            background-color: rgba(13, 110, 253, 0.05);
        }
        .workflow-icon {
            font-size: 3rem;
            color: #6c757d;
        }
        .workflow-type-card:hover .workflow-icon,
        .workflow-type-card.selected .workflow-icon {
            color: #0d6efd;
        }
        .scope-badge {
            background: #0d6efd;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.875rem;
        }
        .file-info {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 2rem;
        }
        .file-icon {
            font-size: 1.5rem;
            color: #6c757d;
        }
    </style>
{% endblock %}

{% block content %}
<div class="workflow-container">
    <div class="workflow-header">
        <div class="d-flex align-items-center justify-content-between">
            <div>
                <h2 class="mb-1"><i class="bi bi-diagram-3 me-2"></i>Workflow - Step 3</h2>
                <p class="mb-0 text-muted">Choose the type of analysis to perform</p>
            </div>
            <div>
                <span class="scope-badge">
                    {% if scope == 'workspace' %}
                        <i class="bi bi-person-workspace me-1"></i>Personal Workspace
                    {% elif scope == 'group' %}
                        <i class="bi bi-people me-1"></i>Group Workspace
                    {% elif scope == 'public' %}
                        <i class="bi bi-globe me-1"></i>Public Workspace
                    {% endif %}
                </span>
            </div>
        </div>
    </div>

    <div class="file-info">
        <div class="d-flex align-items-center">
            <div class="file-icon me-3">
                <i class="bi bi-file-earmark-text"></i>
            </div>
            <div>
                <h6 class="mb-1">Selected Document</h6>
                <p class="mb-0 text-muted" id="selectedFileName">Loading document info...</p>
            </div>
        </div>
    </div>

    <h3 class="mb-4">Choose Workflow Type</h3>
    
    <div class="row g-4">
        <div class="col-md-4">
            <div class="card workflow-type-card h-100" data-type="summary">
                <div class="card-body text-center">
                    <div class="workflow-icon">
                        <i class="bi bi-file-text"></i>
                    </div>
                    <h4 class="card-title mt-3">Document Summary</h4>
                    <p class="card-text text-muted">
                        Generate a comprehensive summary of your document with key points, main themes, and important details.
                    </p>
                    <ul class="list-unstyled text-start text-muted small">
                        <li><i class="bi bi-check-circle text-success me-2"></i>Extracts key information</li>
                        <li><i class="bi bi-check-circle text-success me-2"></i>Identifies main themes</li>
                        <li><i class="bi bi-check-circle text-success me-2"></i>Highlights important details</li>
                        <li><i class="bi bi-check-circle text-success me-2"></i>Enhanced citations support</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card workflow-type-card h-100" data-type="pii_analysis">
                <div class="card-body text-center">
                    <div class="workflow-icon">
                        <i class="bi bi-shield-check"></i>
                    </div>
                    <h4 class="card-title mt-3">PII Analysis</h4>
                    <p class="card-text text-muted">
                        Scan your document for personally identifiable information (PII) and sensitive data patterns.
                    </p>
                    <ul class="list-unstyled text-start text-muted small">
                        <li><i class="bi bi-check-circle text-success me-2"></i>Detects personal information</li>
                        <li><i class="bi bi-check-circle text-success me-2"></i>Identifies sensitive data</li>
                        <li><i class="bi bi-check-circle text-success me-2"></i>Configurable scan patterns</li>
                        <li><i class="bi bi-check-circle text-success me-2"></i>Privacy compliance help</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card workflow-type-card h-100" data-type="translation">
                <div class="card-body text-center">
                    <div class="workflow-icon">
                        <i class="bi bi-translate"></i>
                    </div>
                    <h4 class="card-title mt-3">Document Translation</h4>
                    <p class="card-text text-muted">
                        Translate your document to English automatically or select Spanish, Russian, or Chinese.
                    </p>
                    <ul class="list-unstyled text-start text-muted small">
                        <li><i class="bi bi-check-circle text-success me-2"></i>Auto-detect language</li>
                        <li><i class="bi bi-check-circle text-success me-2"></i>Translate to English</li>
                        <li><i class="bi bi-check-circle text-success me-2"></i>Support for ES/RU/ZH</li>
                        <li><i class="bi bi-check-circle text-success me-2"></i>Powered by OpenAI</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <div class="text-center mt-4">
        <button type="button" class="btn btn-secondary me-2" onclick="history.back()">
            <i class="bi bi-arrow-left me-2"></i>Back
        </button>
        <button id="continueBtn" class="btn btn-primary btn-lg" disabled>
            Start Analysis <i class="bi bi-arrow-right ms-2"></i>
        </button>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const fileId = '{{ file_id }}';
    const scope = '{{ scope }}';
    const workflowCards = document.querySelectorAll('.workflow-type-card');
    const continueBtn = document.getElementById('continueBtn');
    let selectedWorkflowType = null;

    // Load document info
    function loadDocumentInfo() {
        let apiUrl;
        if (scope === 'workspace') {
            apiUrl = `/api/get-document-info/${fileId}`;
        } else if (scope === 'group') {
            apiUrl = `/api/get-group-document-info/${fileId}`;
        } else if (scope === 'public') {
            apiUrl = `/api/get-public-document-info/${fileId}`;
        }

        fetch(apiUrl)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.document) {
                    document.getElementById('selectedFileName').textContent = data.document.filename;
                    updateFileIcon(data.document.filename);
                } else {
                    document.getElementById('selectedFileName').textContent = 'Error loading document info';
                }
            })
            .catch(error => {
                console.error('Error loading document info:', error);
                document.getElementById('selectedFileName').textContent = 'Error loading document info';
            });
    }

    function updateFileIcon(filename) {
        const ext = filename.split('.').pop().toLowerCase();
        const iconElement = document.querySelector('.file-icon i');
        
        switch (ext) {
            case 'pdf':
                iconElement.className = 'bi bi-file-earmark-pdf';
                break;
            case 'docx':
            case 'doc':
                iconElement.className = 'bi bi-file-earmark-word';
                break;
            case 'pptx':
            case 'ppt':
                iconElement.className = 'bi bi-file-earmark-ppt';
                break;
            case 'txt':
                iconElement.className = 'bi bi-file-earmark-text';
                break;
            default:
                iconElement.className = 'bi bi-file-earmark-text';
        }
    }

    // Workflow type selection
    workflowCards.forEach(card => {
        const cardType = card.getAttribute('data-type');
        // Enable summary, PII analysis, and translation
        if (cardType === 'summary' || cardType === 'pii_analysis' || cardType === 'translation') {
            card.addEventListener('click', function() {
                // Remove selected class from all cards
                workflowCards.forEach(c => c.classList.remove('selected'));
                
                // Add selected class to clicked card
                this.classList.add('selected');
                
                // Get the selected workflow type
                selectedWorkflowType = this.getAttribute('data-type');
                
                // Enable continue button
                continueBtn.disabled = false;
            });
        }
    });

    continueBtn.addEventListener('click', function() {
        if (selectedWorkflowType && fileId) {
            // Show loading state
            this.disabled = true;
            this.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status"></span>Processing...';
            
            // Navigate to summary view
            window.location.href = `/workflow/summary-view?file_id=${fileId}&scope=${scope}&summary_type=${selectedWorkflowType}`;
        }
    });

    // Load document info on page load
    loadDocumentInfo();
});
</script>
{% endblock %}