{% extends "base.html" %}
{% block title %}
    Workflow - Summary View - {{ app_settings.app_title }}
{% endblock %}

{% block head %}
    <style>
        .workflow-container {
            max-width: 100%;
            margin: 0;
            padding: 0.5rem;
            height: calc(100vh - 120px);
        }
        .workflow-header {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1rem 1.5rem;
            margin-bottom: 1rem;
            border-left: 4px solid #0d6efd;
        }
        .dual-pane-container {
            display: flex;
            height: calc(100vh - 200px);
            gap: 1rem;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            overflow: hidden;
        }
        .left-pane {
            width: 50%;
            background: #f8f9fa;
            border-right: 1px solid #dee2e6;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .right-pane {
            width: 50%;
            background: white;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        .pane-header {
            background: #fff;
            border-bottom: 1px solid #dee2e6;
            padding: 1rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: between;
        }
        .left-pane .pane-header {
            background: #e9ecef;
            flex-shrink: 0;
        }
        #pdfContainer {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }
        .pdf-viewer {
            width: 100%;
            height: 100%;
            border: none;
            background: white;
            flex: 1;
        }
        .summary-content {
            flex: 1;
            padding: 1.5rem;
            overflow-y: auto;
        }
        .summary-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 200px;
            flex-direction: column;
            color: #6c757d;
        }
        .summary-text {
            line-height: 1.6;
            font-size: 1rem;
        }
        .summary-text h1, .summary-text h2, .summary-text h3 {
            color: #2c3e50;
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
        }
        .summary-text h1 {
            font-size: 1.4rem;
            border-bottom: 2px solid #0d6efd;
            padding-bottom: 0.5rem;
        }
        .summary-text h2 {
            font-size: 1.2rem;
        }
        .summary-text h3 {
            font-size: 1.1rem;
        }
        .summary-text ul, .summary-text ol {
            margin-left: 1rem;
        }
        .summary-text li {
            margin-bottom: 0.3rem;
        }
        .summary-text blockquote {
            border-left: 4px solid #0d6efd;
            padding-left: 1rem;
            margin: 1rem 0;
            font-style: italic;
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 0 4px 4px 0;
        }
        
        /* ========================================
           Markdown Table Styles for Summary Content
           ======================================== */

        /* Base table styling in summary content */
        .summary-text table {
            width: 100%;
            max-width: 100%;
            margin: 0.75rem 0;
            border-collapse: collapse;
            border-spacing: 0;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            overflow: hidden;
            background-color: var(--bs-body-bg);
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            font-size: 0.875rem;
        }

        .summary-text table th,
        .summary-text table td {
            padding: 0.5rem 0.75rem;
            border-bottom: 1px solid #dee2e6;
            border-right: 1px solid #dee2e6;
            text-align: left;
            vertical-align: top;
            word-wrap: break-word;
            line-height: 1.4;
        }

        /* Remove right border on last cell in each row */
        .summary-text table th:last-child,
        .summary-text table td:last-child {
            border-right: none;
        }

        /* Header styling */
        .summary-text table thead th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #495057;
            border-bottom: 2px solid #dee2e6;
        }

        /* Zebra striping for better readability */
        .summary-text table tbody tr:nth-child(even) {
            background-color: rgba(0, 0, 0, 0.02);
        }

        /* Hover effect for table rows */
        .summary-text table tbody tr:hover {
            background-color: rgba(0, 0, 0, 0.04);
            transition: background-color 0.15s ease-in-out;
        }

        /* Responsive table wrapper for horizontal scrolling on small screens */
        .summary-text table {
            display: block;
            white-space: nowrap;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        @media (min-width: 768px) {
            .summary-text table {
                display: table;
                white-space: normal;
            }
        }

        /* Text alignment classes for table cells */
        .summary-text table th[align="center"],
        .summary-text table td[align="center"] {
            text-align: center;
        }

        .summary-text table th[align="right"],
        .summary-text table td[align="right"] {
            text-align: right;
        }

        .summary-text table th[align="left"],
        .summary-text table td[align="left"] {
            text-align: left;
        }

        /* Dark mode table styles */
        [data-bs-theme="dark"] .summary-text table {
            border-color: #495057;
            background-color: var(--bs-dark);
            color: #e9ecef;
        }

        [data-bs-theme="dark"] .summary-text table th,
        [data-bs-theme="dark"] .summary-text table td {
            border-color: #495057;
        }

        [data-bs-theme="dark"] .summary-text table thead th {
            background-color: #343a40;
            color: #e9ecef;
            border-bottom-color: #495057;
        }

        [data-bs-theme="dark"] .summary-text table tbody tr:nth-child(even) {
            background-color: rgba(255, 255, 255, 0.05);
        }

        [data-bs-theme="dark"] .summary-text table tbody tr:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        /* Code blocks within tables */
        .summary-text table code {
            background-color: rgba(0, 0, 0, 0.1);
            padding: 0.125rem 0.25rem;
            border-radius: 0.25rem;
            font-size: 0.8em;
        }

        [data-bs-theme="dark"] .summary-text table code {
            background-color: rgba(255, 255, 255, 0.1);
        }

        /* Links within tables */
        .summary-text table a {
            color: #0d6efd;
            text-decoration: none;
        }

        .summary-text table a:hover {
            color: #0a58ca;
            text-decoration: underline;
        }

        [data-bs-theme="dark"] .summary-text table a {
            color: #86b7fe;
        }

        [data-bs-theme="dark"] .summary-text table a:hover {
            color: #b6d7ff;
        }

        /* Table caption styling */
        .summary-text table caption {
            padding: 0.5rem;
            color: #6c757d;
            text-align: left;
            caption-side: bottom;
            font-size: 0.8em;
            font-style: italic;
        }

        [data-bs-theme="dark"] .summary-text table caption {
            color: #adb5bd;
        }
        .scope-badge {
            background: #0d6efd;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.875rem;
        }
        .summary-type-badge {
            background: #28a745;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.875rem;
        }
        .resizer {
            width: 8px;
            background: #dee2e6;
            cursor: col-resize;
            position: relative;
            user-select: none;
        }
        .resizer:hover {
            background: #0d6efd;
        }
        .resizer::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 2px;
            height: 30px;
            background: #6c757d;
            border-radius: 1px;
        }
        .action-buttons {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        .error-state {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            flex-direction: column;
            color: #dc3545;
        }
        .success-state {
            display: none;
        }
        @media (max-width: 992px) {
            .dual-pane-container {
                flex-direction: column;
                height: auto;
            }
            .left-pane, .right-pane {
                width: 100%;
            }
            .left-pane {
                height: 400px;
                border-right: none;
                border-bottom: 1px solid #dee2e6;
            }
            .resizer {
                display: none;
            }
        }
    </style>
{% endblock %}

{% block content %}
<div class="workflow-container">
    <div class="workflow-header">
        <div class="d-flex align-items-center justify-content-between">
            <div>
                <h2 class="mb-1"><i class="bi bi-diagram-3 me-2"></i>Workflow Results</h2>
                <p class="mb-0 text-muted">Document analysis with enhanced citations</p>
            </div>
            <div class="d-flex gap-2">
                <span class="scope-badge">
                    {% if scope == 'workspace' %}
                        <i class="bi bi-person-workspace me-1"></i>Personal
                    {% elif scope == 'group' %}
                        <i class="bi bi-people me-1"></i>Group
                    {% elif scope == 'public' %}
                        <i class="bi bi-globe me-1"></i>Public
                    {% endif %}
                </span>
                <span class="summary-type-badge">
                    {% if summary_type == 'pii_analysis' %}
                        <i class="bi bi-shield-check me-1"></i>PII Analysis
                    {% else %}
                        <i class="bi bi-file-text me-1"></i>{{ summary_type.title() }}
                    {% endif %}
                </span>
            </div>
        </div>
    </div>

    <div class="dual-pane-container">
        <!-- Left Pane - PDF Viewer -->
        <div class="left-pane">
            <div class="pane-header">
                <div class="d-flex align-items-center justify-content-between w-100">
                    <div>
                        <i class="bi bi-file-pdf me-2"></i>
                        <span id="documentTitle">Loading document...</span>
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-sm btn-outline-primary" id="fullscreenPdfBtn" title="View fullscreen">
                            <i class="bi bi-arrows-fullscreen"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-primary" id="downloadPdfBtn" title="Download PDF">
                            <i class="bi bi-download"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div id="pdfContainer">
                <iframe id="pdfViewer" class="pdf-viewer" src="" title="Document PDF">
                    Your browser does not support PDF viewing.
                </iframe>
            </div>
        </div>

        <!-- Resizer -->
        <div class="resizer" id="resizer"></div>

        <!-- Right Pane - Summary -->
        <div class="right-pane">
            <div class="pane-header">
                <div class="d-flex align-items-center justify-content-between w-100">
                    <div>
                        {% if summary_type == 'pii_analysis' %}
                            <i class="bi bi-shield-check me-2"></i>
                            <span>Generated PII Analysis</span>
                        {% else %}
                            <i class="bi bi-file-text me-2"></i>
                            <span>Generated Summary</span>
                        {% endif %}
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-sm btn-outline-primary" id="regenerateSummaryBtn" title="Regenerate summary">
                            <i class="bi bi-arrow-clockwise"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-primary" id="copySummaryBtn" title="Copy summary">
                            <i class="bi bi-clipboard"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-primary" id="downloadSummaryBtn" title="Download summary">
                            <i class="bi bi-download"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="summary-content">
                <!-- Loading State -->
                <div class="summary-loading" id="summaryLoading">
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <h5>Generating Summary</h5>
                    <p class="text-muted">Please wait while we analyze your document...</p>
                    <div class="progress" style="width: 200px;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%" id="summaryProgress"></div>
                    </div>
                </div>

                <!-- Error State -->
                <div class="error-state" id="summaryError" style="display: none;">
                    <i class="bi bi-exclamation-triangle" style="font-size: 3rem;"></i>
                    <h5 class="mt-3">Summary Generation Failed</h5>
                    <p class="text-muted">There was an error generating the summary. Please try again.</p>
                    <button class="btn btn-primary" id="retryBtn">
                        <i class="bi bi-arrow-clockwise me-2"></i>Retry
                    </button>
                </div>

                <!-- Success State -->
                <div class="success-state" id="summarySuccess">
                    <div class="summary-text" id="summaryText">
                        <!-- Summary content will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="text-center mt-3">
        <button type="button" class="btn btn-secondary" onclick="window.location.href='/workflow'">
            <i class="bi bi-arrow-left me-2"></i>New Workflow
        </button>
        <button type="button" class="btn btn-outline-primary" onclick="history.back()">
            <i class="bi bi-arrow-left me-2"></i>Back
        </button>
    </div>
</div>

<!-- Dependencies for markdown table processing -->
<script src="https://cdn.jsdelivr.net/npm/marked@15.0.7/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.7/dist/purify.min.js"></script>

<script>
// Configure marked with GFM tables support
marked.setOptions({
    gfm: true,
    breaks: true,
    tables: true
});

// Configure DOMPurify to allow table elements
const purifyConfig = {
    ALLOWED_TAGS: [
        'p', 'br', 'strong', 'em', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6', 
        'ul', 'ol', 'li', 'blockquote', 'a', 'code', 'pre',
        'table', 'thead', 'tbody', 'tr', 'th', 'td', 'caption'
    ],
    ALLOWED_ATTR: ['href', 'target', 'align', 'class']
};

/**
 * Unwraps markdown tables that are mistakenly wrapped in code blocks.
 */
function unwrapTablesFromCodeBlocks(content) {
    const codeBlockTablePattern = /```(?:\w+)?\n((?:[^\n]*\|[^\n]*\n)+(?:\|[-\s|:]+\|\n)?(?:[^\n]*\|[^\n]*\n)*)\n?```/g;
    
    return content.replace(codeBlockTablePattern, (match, tableContent) => {
        const lines = tableContent.trim().split('\n');
        
        if (lines.length >= 2) {
            const hasTableStructure = lines.every(line => line.includes('|'));
            const hasSeparatorLine = lines.some(line => /^[\s|:-]+$/.test(line));
            
            if (hasTableStructure && (hasSeparatorLine || lines.length >= 3)) {
                return '\n\n' + tableContent.trim() + '\n\n';
            }
        }
        
        return match;
    });
}

/**
 * Converts Unicode box-drawing tables to markdown table format.
 */
function convertUnicodeTableToMarkdown(content) {
    const unicodeTablePattern = /┌[─┬]+┐\n(?:│[^│\n]*│[^│\n]*│[^\n]*\n)+├[─┼]+┤\n(?:│[^│\n]*│[^│\n]*│[^\n]*\n)+└[─┴]+┘/g;
    
    return content.replace(unicodeTablePattern, (match) => {
        try {
            const lines = match.split('\n');
            const dataLines = [];
            let headerLine = null;
            
            for (const line of lines) {
                if (line.includes('│') && !line.includes('┌') && !line.includes('├') && !line.includes('└')) {
                    const cells = line.split('│')
                        .filter(cell => cell.trim() !== '')
                        .map(cell => cell.trim());
                    
                    if (cells.length > 0) {
                        if (!headerLine) {
                            headerLine = cells;
                        } else {
                            dataLines.push(cells);
                        }
                    }
                }
            }
            
            if (headerLine && dataLines.length > 0) {
                let markdownTable = '\n\n';
                markdownTable += '| ' + headerLine.join(' | ') + ' |\n';
                markdownTable += '|' + headerLine.map(() => '---').join('|') + '|\n';
                
                const displayRows = dataLines.slice(0, 10);
                for (const row of displayRows) {
                    markdownTable += '| ' + row.join(' | ') + ' |\n';
                }
                
                if (dataLines.length > 10) {
                    markdownTable += '\n*Showing first 10 of ' + dataLines.length + ' total rows*\n';
                }
                
                markdownTable += '\n';
                return markdownTable;
            }
        } catch (error) {
            console.error('Error converting Unicode table:', error);
        }
        
        return match;
    });
}

/**
 * Converts pipe-separated values (PSV) in code blocks to markdown table format.
 */
function convertPSVCodeBlockToMarkdown(content) {
    const psvCodeBlockPattern = /```(?:\w+)?\n([^`]+?)\n```/g;
    
    return content.replace(psvCodeBlockPattern, (match, codeContent) => {
        const lines = codeContent.trim().split('\n');
        
        if (lines.length >= 2) {
            const firstLine = lines[0];
            const hasConsistentPipes = lines.every(line => {
                const pipeCount = (line.match(/\|/g) || []).length;
                const firstLinePipeCount = (firstLine.match(/\|/g) || []).length;
                return pipeCount === firstLinePipeCount && pipeCount > 0;
            });
            
            if (hasConsistentPipes) {
                try {
                    const headerRow = lines[0].split('|').map(cell => cell.trim());
                    const dataRows = lines.slice(1).map(line => 
                        line.split('|').map(cell => cell.trim())
                    );
                    
                    let markdownTable = '\n\n';
                    markdownTable += '| ' + headerRow.join(' | ') + ' |\n';
                    markdownTable += '|' + headerRow.map(() => '---').join('|') + '|\n';
                    
                    const displayRows = dataRows.slice(0, 50);
                    for (const row of displayRows) {
                        markdownTable += '| ' + row.join(' | ') + ' |\n';
                    }
                    
                    if (dataRows.length > 50) {
                        markdownTable += '\n*Showing first 50 of ' + dataRows.length + ' total rows*\n';
                    }
                    
                    markdownTable += '\n';
                    return markdownTable;
                } catch (error) {
                    console.error('Error converting PSV to markdown:', error);
                }
            }
        }
        
        return match;
    });
}

/**
 * Converts ASCII dash tables to markdown table format.
 */
function convertASCIIDashTableToMarkdown(content) {
    try {
        const lines = content.split('\n');
        const dashLineIndices = [];
        
        for (let i = 0; i < lines.length; i++) {
            const line = lines[i];
            if (line.includes('─') && line.replace(/[─\s]/g, '').length === 0 && line.length > 10) {
                dashLineIndices.push(i);
            }
        }
        
        let processedContent = content;
        
        if (dashLineIndices.length >= 2) {
            let i = dashLineIndices.length - 1;
            while (i >= 0) {
                let tableStart = i;
                while (tableStart > 0 && 
                       dashLineIndices[tableStart] - dashLineIndices[tableStart - 1] <= 10) {
                    tableStart--;
                }
                
                const firstDashIdx = dashLineIndices[tableStart];
                const lastDashIdx = dashLineIndices[i];
                
                const headerLine = lines[firstDashIdx + 1];
                
                if (headerLine && headerLine.trim()) {
                    const headerCells = headerLine.split(/\s{2,}/)
                        .map(cell => cell.trim())
                        .filter(cell => cell !== '');
                    
                    const processedDataRows = [];
                    for (let lineIdx = firstDashIdx + 2; lineIdx < lastDashIdx; lineIdx++) {
                        const line = lines[lineIdx];
                        if (line.includes('─') && line.replace(/[─\s]/g, '').length === 0) {
                            continue;
                        }
                        
                        if (line.trim()) {
                            const dataCells = line.split(/\s{2,}/)
                                .map(cell => cell.trim())
                                .filter(cell => cell !== '');
                            
                            if (dataCells.length > 1) {
                                processedDataRows.push(dataCells);
                            }
                        }
                    }
                    
                    if (headerCells.length > 1 && processedDataRows.length > 0) {
                        let markdownTable = '\n\n';
                        markdownTable += '| ' + headerCells.join(' | ') + ' |\n';
                        markdownTable += '|' + headerCells.map(() => '---').join('|') + '|\n';
                        
                        for (const row of processedDataRows) {
                            while (row.length < headerCells.length) {
                                row.push('—');
                            }
                            const trimmedRow = row.slice(0, headerCells.length);
                            markdownTable += '| ' + trimmedRow.join(' | ') + ' |\n';
                        }
                        markdownTable += '\n';
                        
                        const tableSection = lines.slice(firstDashIdx, lastDashIdx + 1);
                        const originalTableText = tableSection.join('\n');
                        processedContent = processedContent.replace(originalTableText, markdownTable);
                    }
                }
                
                i = tableStart - 1;
            }
        }
        
        return processedContent;
        
    } catch (error) {
        console.error('Error converting ASCII dash table:', error);
        return content;
    }
}

document.addEventListener('DOMContentLoaded', function() {
    const fileId = '{{ file_id }}';
    const scope = '{{ scope }}';
    const summaryType = '{{ summary_type }}';
    
    // Elements
    const pdfViewer = document.getElementById('pdfViewer');
    const documentTitle = document.getElementById('documentTitle');
    const summaryLoading = document.getElementById('summaryLoading');
    const summaryError = document.getElementById('summaryError');
    const summarySuccess = document.getElementById('summarySuccess');
    const summaryText = document.getElementById('summaryText');
    const summaryProgress = document.getElementById('summaryProgress');
    const leftPane = document.querySelector('.left-pane');
    const rightPane = document.querySelector('.right-pane');
    const resizer = document.getElementById('resizer');
    
    let isResizing = false;
    let documentData = null;

    // Initialize the view
    async function initialize() {
        try {
            await loadDocumentInfo();
            await loadPdfViewer();
            await generateSummary();
        } catch (error) {
            console.error('Error initializing workflow view:', error);
            showError('Failed to initialize workflow view');
        }
    }

    // Load document information
    async function loadDocumentInfo() {
        let apiUrl;
        if (scope === 'workspace') {
            apiUrl = `/api/get-document-info/${fileId}`;
        } else if (scope === 'group') {
            apiUrl = `/api/get-group-document-info/${fileId}`;
        } else if (scope === 'public') {
            apiUrl = `/api/get-public-document-info/${fileId}`;
        }

        const response = await fetch(apiUrl);
        const data = await response.json();
        
        if (data.success && data.document) {
            documentData = data.document;
            documentTitle.textContent = data.document.filename;
        } else {
            throw new Error('Failed to load document information');
        }
    }

    // Load PDF viewer with all pages
    function loadPdfViewer() {
        // Use the dedicated workflow PDF endpoint that allows iframe embedding
        const pdfUrl = `/api/workflow/pdf?doc_id=${encodeURIComponent(fileId)}`;
        console.log('DEBUG: Loading PDF with dedicated workflow URL:', pdfUrl);
        pdfViewer.src = pdfUrl;
        
        pdfViewer.onload = function() {
            console.log('PDF loaded successfully');
        };
        
        pdfViewer.onerror = function() {
            console.error('Failed to load PDF');
            console.error('PDF URL that failed:', pdfUrl);
            showError('Failed to load PDF document');
        };
    }

    // Generate summary or analysis
    async function generateSummary() {
        try {
            updateProgress(10);
            
            let apiUrl, requestBody;
            
            if (summaryType === 'pii_analysis') {
                apiUrl = '/api/workflow/generate-pii-analysis';
                requestBody = {
                    file_id: fileId,
                    scope: scope
                };
            } else {
                apiUrl = '/api/workflow/generate-summary';
                requestBody = {
                    file_id: fileId,
                    scope: scope,
                    summary_type: summaryType
                };
            }
            
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestBody)
            });

            updateProgress(50);

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            updateProgress(100);

            if (data.success) {
                const content = summaryType === 'pii_analysis' ? data.pii_analysis : data.summary;
                showSuccess(content);
            } else {
                throw new Error(data.error || `Failed to generate ${summaryType === 'pii_analysis' ? 'PII analysis' : 'summary'}`);
            }
        } catch (error) {
            console.error(`Error generating ${summaryType === 'pii_analysis' ? 'PII analysis' : 'summary'}:`, error);
            showError(error.message);
        }
    }

    function updateProgress(percent) {
        summaryProgress.style.width = percent + '%';
    }

    function showError(message) {
        summaryLoading.style.display = 'none';
        summarySuccess.style.display = 'none';
        summaryError.style.display = 'flex';
        summaryError.querySelector('p').textContent = message;
    }

    function showSuccess(summary) {
        summaryLoading.style.display = 'none';
        summaryError.style.display = 'none';
        summarySuccess.style.display = 'block';
        
        // Convert markdown-like formatting to HTML
        const formattedSummary = formatSummaryText(summary);
        summaryText.innerHTML = formattedSummary;
    }

    function formatSummaryText(text) {
        // Use the same comprehensive markdown processing pipeline as chat messages
        try {
            // Apply table conversion functions in sequence
            const withUnwrappedTables = unwrapTablesFromCodeBlocks(text);
            const withMarkdownTables = convertUnicodeTableToMarkdown(withUnwrappedTables);
            const withPSVTables = convertPSVCodeBlockToMarkdown(withMarkdownTables);
            const withASCIITables = convertASCIIDashTableToMarkdown(withPSVTables);
            
            // Parse markdown to HTML using Marked.js
            const htmlContent = DOMPurify.sanitize(marked.parse(withASCIITables), purifyConfig);
            
            // Add Bootstrap table classes to any tables
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = htmlContent;
            const tables = tempDiv.querySelectorAll('table');
            tables.forEach(table => {
                table.className = 'table table-striped table-hover table-bordered';
            });
            
            return tempDiv.innerHTML;
        } catch (error) {
            console.error('Error formatting summary text:', error);
            // Fallback to original basic formatting if there's an error
            return text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/^### (.*$)/gm, '<h3>$1</h3>')
                .replace(/^## (.*$)/gm, '<h2>$1</h2>')
                .replace(/^# (.*$)/gm, '<h1>$1</h1>')
                .replace(/^\* (.*)$/gm, '<li>$1</li>')
                .replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>')
                .replace(/\n\n/g, '</p><p>')
                .replace(/^(.*)$/gm, '<p>$1</p>')
                .replace(/<p><\/p>/g, '')
                .replace(/<p>(<h[1-3]>.*<\/h[1-3]>)<\/p>/g, '$1')
                .replace(/<p>(<ul>.*<\/ul>)<\/p>/g, '$1');
        }
    }

    // Resizer functionality
    resizer.addEventListener('mousedown', function(e) {
        isResizing = true;
        document.addEventListener('mousemove', handleMouseMove);
        document.addEventListener('mouseup', function() {
            isResizing = false;
            document.removeEventListener('mousemove', handleMouseMove);
        });
    });

    function handleMouseMove(e) {
        if (!isResizing) return;
        
        const containerRect = document.querySelector('.dual-pane-container').getBoundingClientRect();
        const percentage = ((e.clientX - containerRect.left) / containerRect.width) * 100;
        
        if (percentage >= 20 && percentage <= 80) {
            leftPane.style.width = percentage + '%';
            rightPane.style.width = (100 - percentage) + '%';
        }
    }

    // Button event handlers
    document.getElementById('fullscreenPdfBtn').addEventListener('click', function() {
        if (pdfViewer.requestFullscreen) {
            pdfViewer.requestFullscreen();
        }
    });

    document.getElementById('downloadPdfBtn').addEventListener('click', function() {
        const downloadUrl = `/api/enhanced_citations/pdf?doc_id=${encodeURIComponent(fileId)}&download=true`;
        window.open(downloadUrl, '_blank');
    });

    document.getElementById('regenerateSummaryBtn').addEventListener('click', function() {
        summarySuccess.style.display = 'none';
        summaryError.style.display = 'none';
        summaryLoading.style.display = 'flex';
        updateProgress(0);
        generateSummary();
    });

    document.getElementById('copySummaryBtn').addEventListener('click', function() {
        const textToCopy = summaryText.textContent;
        navigator.clipboard.writeText(textToCopy).then(function() {
            // Show a temporary success indicator
            const btn = document.getElementById('copySummaryBtn');
            const originalHtml = btn.innerHTML;
            btn.innerHTML = '<i class="bi bi-check"></i>';
            btn.classList.add('btn-success');
            btn.classList.remove('btn-outline-primary');
            
            setTimeout(() => {
                btn.innerHTML = originalHtml;
                btn.classList.remove('btn-success');
                btn.classList.add('btn-outline-primary');
            }, 2000);
        });
    });

    document.getElementById('downloadSummaryBtn').addEventListener('click', function() {
        const textContent = summaryText.textContent;
        const blob = new Blob([textContent], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `summary_${documentData ? documentData.filename : 'document'}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    });

    document.getElementById('retryBtn').addEventListener('click', function() {
        summaryError.style.display = 'none';
        summaryLoading.style.display = 'flex';
        updateProgress(0);
        generateSummary();
    });

    // Initialize the application
    initialize();
});
</script>
{% endblock %}